<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="theme-color" content="#004680">
  <title>Dosed ‚Äî Ultimate Child Health Tracker</title>
  <link rel="manifest" href="manifest.json">
  
  <!-- Google Fonts - EB Garamond -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=EB+Garamond:wght@400;500;600;700&display=swap" rel="stylesheet">
  
  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Lucide icons CDN -->
  <script src="https://unpkg.com/lucide@0.278.0/dist/lucide.min.js"></script>
  
  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <style>
    /* EB Garamond font family */
    body {
      font-family: 'EB Garamond', 'Garamond', 'Cormorant Garamond', Georgia, serif;
    }
    
    /* Ensure headings and buttons use the font too */
    h1, h2, h3, h4, h5, h6, button, input, select, textarea {
      font-family: 'EB Garamond', 'Garamond', Georgia, serif;
    }
    
    .modal-backdrop { background: rgba(0,0,0,0.4); }
    .cursor-hand { cursor: pointer; }
    .small-txt { font-size: 0.8rem; }
    .child-card-active { border: 3px solid #004680; background: #E6F0F8; }
    .medication-status-due { background: #FEF3C7; border-left: 4px solid #F59E0B; }
    .medication-status-overdue { background: #FEE2E2; border-left: 4px solid #EF4444; }
    .time-btn { transition: all 0.2s; }
    .time-btn.active { background: #004680; color: white; }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-blue-50 to-[#E6F0F8] p-4">

  <div class="max-w-4xl mx-auto">
    <!-- Header -->
    <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
      <div class="flex items-center gap-2">
        <i data-lucide="thermometer" class="text-red-500"></i>
        <h1 class="text-3xl font-bold text-[#004680]">Dosed</h1>
        <span class="text-xs bg-[#7B68A6]100 text-[#7B68A6]800 px-2 py-1 rounded-full ml-2">Ultimate</span>
      </div>
      <p class="text-gray-600 mt-2">Complete child health tracking with prescriptions & custom timestamps</p>
    </div>

    <!-- Reminder Banner -->
    <div id="reminderBanner" class="hidden bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-6 rounded-lg">
      <div class="flex items-start">
        <i data-lucide="bell" class="text-yellow-600 mr-3 mt-1"></i>
        <div>
          <h3 class="font-semibold text-yellow-800">Medication Reminders</h3>
          <div id="remindersList" class="mt-1 text-sm text-yellow-700"></div>
        </div>
      </div>
    </div>

    <!-- Children Section -->
    <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-bold text-gray-800">Children</h2>
        <button id="btnAddChild" class="bg-[#004680] text-white px-4 py-2 rounded-lg flex items-center gap-2 hover:bg-[#003a6b]">
          <i data-lucide="plus"></i> Add Child
        </button>
      </div>

      <div id="childrenGrid" class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <!-- children cards injected here -->
      </div>
    </div>

    <!-- Charts Section -->
    <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-bold text-gray-800">Charts</h2>
        <button id="btnToggleTrends" class="bg-gray-200 px-3 py-1 rounded hover:bg-gray-300">Toggle Trends</button>
      </div>

      <div id="chartArea" class="hidden space-y-6">
        <div>
          <h3 class="text-sm font-semibold mb-2">Temperature Over Time</h3>
          <canvas id="tempChart" height="120"></canvas>
        </div>
        <div>
          <h3 class="text-sm font-semibold mb-2">Heart Rate</h3>
          <canvas id="hrChart" height="120"></canvas>
        </div>
        <div>
          <h3 class="text-sm font-semibold mb-2">Respiratory Rate</h3>
          <canvas id="rrChart" height="120"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Backdrop -->
  <div id="modalBackdrop" class="fixed inset-0 hidden items-center justify-center modal-backdrop z-40">
    <div id="modal" class="bg-white rounded-lg shadow-lg w-full max-w-2xl max-h-[90vh] overflow-y-auto p-6 mx-4">
      <!-- modal content injected -->
    </div>
  </div>

<script>
/* ===========================
   Medicine Database
   =========================== */

// Common Irish medicine barcodes (EAN-13)
const MEDICINE_BARCODES = {
  '5000347005916': 'Calpol Infant (120mg/5ml)',
  '5000347006012': 'Calpol Six Plus (250mg/5ml)',
  '5000347006241': 'Calpol Infant Suspension Sugar Free',
  '5000347009747': 'Nurofen for Children (100mg/5ml)',
  '5000347009754': 'Nurofen for Children Orange',
  '5000347009761': 'Nurofen for Children Strawberry',
  '5391516691819': 'Pinamox Suspension',
  // Add more as needed - users can also add custom entries
};

const COMMON_SYMPTOMS = [
  'Cough', 'Runny nose', 'Congestion', 'Sore throat', 'Earache',
  'Headache', 'Vomiting', 'Diarrhea', 'Rash', 'Difficulty breathing',
  'Wheezing', 'Lethargy', 'Poor feeding', 'Irritability', 'Seizure'
];

const MEDICINES = [
  { 
    name: 'Calpol Infant (120mg/5ml)', 
    generic: 'paracetamol', 
    concentration: '120mg/5ml', 
    category: 'Antipyretic/Analgesic',
    interval: 4,
    dosageGuide: [
      { minWeight: 4, maxWeight: 8, dose: 2.5, ageGuide: '2-3 months' },
      { minWeight: 8, maxWeight: 10, dose: 5, ageGuide: '3-6 months' },
      { minWeight: 10, maxWeight: 13, dose: 7.5, ageGuide: '6-24 months' },
      { minWeight: 13, maxWeight: 15, dose: 10, ageGuide: '2-4 years' },
      { minWeight: 15, maxWeight: 21, dose: 10, ageGuide: '4-6 years' },
      { minWeight: 21, maxWeight: 27, dose: 15, ageGuide: '6-8 years' },
      { minWeight: 27, maxWeight: 33, dose: 15, ageGuide: '8-10 years' },
      { minWeight: 33, maxWeight: 43, dose: 20, ageGuide: '10-12 years' }
    ]
  },
  { 
    name: 'Calpol Six Plus (250mg/5ml)', 
    generic: 'paracetamol', 
    concentration: '250mg/5ml', 
    category: 'Antipyretic/Analgesic',
    interval: 4,
    dosageGuide: [
      { minWeight: 15, maxWeight: 21, dose: 5, ageGuide: '6-8 years' },
      { minWeight: 21, maxWeight: 27, dose: 7.5, ageGuide: '8-10 years' },
      { minWeight: 27, maxWeight: 43, dose: 10, ageGuide: '10-12 years' }
    ]
  },
  { 
    name: 'Nurofen for Children (100mg/5ml)', 
    generic: 'ibuprofen', 
    concentration: '100mg/5ml', 
    category: 'Antipyretic/Analgesic',
    interval: 6,
    dosageGuide: [
      { minWeight: 7, maxWeight: 9, dose: 2.5, ageGuide: '3-6 months' },
      { minWeight: 9, maxWeight: 11, dose: 2.5, ageGuide: '6-12 months' },
      { minWeight: 11, maxWeight: 16, dose: 5, ageGuide: '1-3 years' },
      { minWeight: 16, maxWeight: 21, dose: 7.5, ageGuide: '4-6 years' },
      { minWeight: 21, maxWeight: 27, dose: 10, ageGuide: '7-9 years' },
      { minWeight: 27, maxWeight: 40, dose: 15, ageGuide: '10-12 years' }
    ]
  },
  { 
    name: 'Amoxicillin Suspension (125mg/5ml)', 
    generic: 'amoxicillin', 
    concentration: '125mg/5ml', 
    category: 'Antibiotic',
    interval: 8,
    dosageGuide: [
      { minWeight: 10, maxWeight: 15, dose: 5, ageGuide: '1-3 years' },
      { minWeight: 15, maxWeight: 20, dose: 7.5, ageGuide: '3-6 years' },
      { minWeight: 20, maxWeight: 30, dose: 10, ageGuide: '6-12 years' }
    ]
  },
  { 
    name: 'Amoxicillin Suspension (250mg/5ml)', 
    generic: 'amoxicillin', 
    concentration: '250mg/5ml', 
    category: 'Antibiotic',
    interval: 8,
    dosageGuide: [
      { minWeight: 20, maxWeight: 30, dose: 5, ageGuide: '6-12 years' },
      { minWeight: 30, maxWeight: 40, dose: 7.5, ageGuide: '12+ years' }
    ]
  },
  { 
    name: 'Ventolin Inhaler (100mcg/puff)', 
    generic: 'salbutamol', 
    category: 'Asthma - Reliever', 
    unit: 'puffs',
    interval: 4,
    dosageGuide: [
      { minWeight: 0, maxWeight: 100, dose: 1, ageGuide: 'All ages', notes: '1-2 puffs as needed' }
    ]
  },
  { 
    name: 'Piriton Syrup (2mg/5ml)', 
    generic: 'chlorphenamine', 
    concentration: '2mg/5ml', 
    category: 'Antihistamine',
    interval: 6,
    dosageGuide: [
      { minWeight: 10, maxWeight: 20, dose: 2.5, ageGuide: '1-2 years' },
      { minWeight: 20, maxWeight: 30, dose: 2.5, ageGuide: '2-6 years' },
      { minWeight: 30, maxWeight: 45, dose: 5, ageGuide: '6-12 years' }
    ]
  },
  { 
    name: 'Pinamox Suspension', 
    generic: 'amoxicillin', 
    concentration: '125mg/5ml', 
    category: 'Antibiotic',
    interval: 8,
    dosageGuide: [
      { minWeight: 10, maxWeight: 20, dose: 5, ageGuide: '1-6 years' },
      { minWeight: 20, maxWeight: 30, dose: 10, ageGuide: '6-12 years' }
    ]
  },
  { 
    name: 'Disprol (120mg/5ml)', 
    generic: 'paracetamol', 
    concentration: '120mg/5ml', 
    category: 'Antipyretic/Analgesic',
    interval: 4,
    dosageGuide: [
      { minWeight: 8, maxWeight: 13, dose: 5, ageGuide: '3-12 months' },
      { minWeight: 13, maxWeight: 21, dose: 10, ageGuide: '1-6 years' }
    ]
  }
];

/* ===========================
   Storage
   =========================== */

const STORAGE_KEYS = {
  children: 'dosed_children',
  records: 'dosed_records',
  prescriptions: 'dosed_prescriptions'
};

function loadData() {
  const children = JSON.parse(localStorage.getItem(STORAGE_KEYS.children) || '[]');
  const records = JSON.parse(localStorage.getItem(STORAGE_KEYS.records) || '[]');
  const prescriptions = JSON.parse(localStorage.getItem(STORAGE_KEYS.prescriptions) || '[]');
  return { children, records, prescriptions };
}

function saveData({ children, records, prescriptions }) {
  localStorage.setItem(STORAGE_KEYS.children, JSON.stringify(children));
  localStorage.setItem(STORAGE_KEYS.records, JSON.stringify(records));
  localStorage.setItem(STORAGE_KEYS.prescriptions, JSON.stringify(prescriptions));
}

let state = loadData();

/* ===========================
   Utilities
   =========================== */

function uid() { return Date.now().toString(36) + Math.random().toString(36).slice(2,8); }

function formatDateTime(iso) {
  const d = new Date(iso);
  return d.toLocaleString('en-GB', { 
    day: 'numeric', 
    month: 'short', 
    year: 'numeric',
    hour: '2-digit', 
    minute: '2-digit' 
  });
}

function escapeHtml(str) {
  const div = document.createElement('div');
  div.textContent = str || '';
  return div.innerHTML;
}

function escapeAttr(str) {
  return (str || '').replace(/"/g, '&quot;');
}

function calculateNextDoseISO(frequency) {
  const now = new Date();
  const hoursToAdd = frequency === 'TDS' ? 8 : frequency === 'BD' ? 12 : frequency === 'QDS' ? 6 : 24;
  now.setHours(now.getHours() + hoursToAdd);
  return now.toISOString();
}

function getRecommendedDose(medName, weight) {
  const med = MEDICINES.find(m => m.name === medName);
  if (!med || !weight || !med.dosageGuide) return null;
  
  const w = parseFloat(weight);
  const guide = med.dosageGuide.find(g => w >= g.minWeight && w <= g.maxWeight);
  if (!guide) return null;
  
  return {
    dose: guide.dose,
    ageGuide: guide.ageGuide,
    unit: med.unit || 'ml',
    notes: guide.notes,
    interval: med.interval || 4
  };
}

/* ===========================
   Active Medications Tracking
   =========================== */

function getActiveMedications(childId) {
  const medRecords = state.records
    .filter(r => r.childId === childId && r.medication)
    .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
  
  const activeMeds = [];
  const seenMeds = new Set();
  
  for (const med of medRecords) {
    if (!seenMeds.has(med.medication)) {
      const hoursSince = (Date.now() - new Date(med.timestamp).getTime()) / (1000 * 60 * 60);
      if (hoursSince < 24) {
        const medData = MEDICINES.find(m => m.name === med.medication);
        const interval = medData?.interval || 4;
        activeMeds.push({
          name: med.medication,
          timestamp: med.timestamp,
          interval: interval
        });
      }
      seenMeds.add(med.medication);
    }
  }
  
  return activeMeds;
}

/* ===========================
   Reminders
   =========================== */

function checkReminders() {
  const now = new Date();
  const reminders = [];
  
  // Check prescriptions
  state.prescriptions.forEach(p => {
    if (p.nextDose) {
      const next = new Date(p.nextDose);
      const diff = next - now;
      if (diff > 0 && diff < 15 * 60 * 1000) {
        const child = state.children.find(c => c.id === p.childId);
        reminders.push({
          medication: p.medication,
          childName: child ? child.name : 'Unknown',
          minutesUntil: Math.max(0, Math.floor(diff / 60000))
        });
      }
    }
  });
  
  // Check active medications
  state.children.forEach(child => {
    const meds = getActiveMedications(child.id);
    meds.forEach(med => {
      const nextDose = new Date(new Date(med.timestamp).getTime() + (med.interval * 60 * 60 * 1000));
      const diff = nextDose - now;
      if (diff < 0 && diff > -30 * 60 * 1000) { // Overdue by less than 30 min
        reminders.push({
          medication: med.name,
          childName: child.name,
          minutesUntil: 'OVERDUE'
        });
      }
    });
  });

  const banner = document.getElementById('reminderBanner');
  const list = document.getElementById('remindersList');
  if (reminders.length > 0) {
    banner.classList.remove('hidden');
    list.innerHTML = reminders.map(r => 
      `${r.childName}: ${r.medication} ${r.minutesUntil === 'OVERDUE' ? '<span class="font-bold text-red-700">OVERDUE</span>' : `due in ${r.minutesUntil} minute(s)`}`
    ).join('<br/>');
  } else {
    banner.classList.add('hidden');
    list.innerHTML = '';
  }
}

/* ===========================
   Rendering
   =========================== */

function render() {
  renderChildren();
  checkReminders();
  lucide.createIcons();
}

function persistAndRender() {
  saveData(state);
  render();
}

function renderChildren() {
  const grid = document.getElementById('childrenGrid');
  if (state.children.length === 0) {
    grid.innerHTML = '<div class="col-span-2 text-center text-gray-500 py-8">No children added yet. Click "Add Child" to get started.</div>';
    return;
  }
  
  grid.innerHTML = state.children.map(child => {
    const records = getRecordsForChild(child.id);
    const prescriptions = getPrescriptionsForChild(child.id);
    const activeMeds = getActiveMedications(child.id);
    
    let medStatusHTML = '';
    if (activeMeds.length > 0) {
      medStatusHTML = activeMeds.map(med => {
        const nextDose = new Date(new Date(med.timestamp).getTime() + (med.interval * 60 * 60 * 1000));
        const isOverdue = nextDose < new Date();
        const isDue = (nextDose - new Date()) < (30 * 60 * 1000);
        const statusClass = isOverdue ? 'medication-status-overdue' : isDue ? 'medication-status-due' : 'bg-blue-50 border-l-4 border-blue-400';
        
        return `
          <div class="${statusClass} p-2 rounded text-sm mt-2">
            <div class="font-semibold">${escapeHtml(med.name)}</div>
            <div class="text-xs text-gray-600">Last: ${formatDateTime(med.timestamp)}</div>
            <div class="text-xs ${isOverdue ? 'text-red-700 font-bold' : 'text-blue-700'}">
              ${isOverdue ? 'üö® OVERDUE' : isDue ? '‚è∞ Due soon' : `Next: ${nextDose.toLocaleTimeString('en-GB', {hour: '2-digit', minute: '2-digit'})}`}
            </div>
          </div>
        `;
      }).join('');
    }
    
    return `
      <div class="border rounded-lg p-4 hover:shadow-md transition-shadow" id="child-${child.id}">
        <div class="flex justify-between items-start mb-2">
          <div>
            <h3 class="text-lg font-bold">${escapeHtml(child.name)}</h3>
            <div class="text-sm text-gray-600">Age: ${child.age || 'Not set'} ${child.weight ? `‚Ä¢ ${child.weight} kg` : ''}</div>
          </div>
          <button class="btn-delete-child text-red-500 hover:text-red-700" data-id="${child.id}">
            <i data-lucide="trash-2" class="w-4 h-4"></i>
          </button>
        </div>
        
        ${child.conditions && child.conditions.length ? `
          <div class="text-xs text-gray-600 mb-1">
            <i data-lucide="heart-pulse" class="w-3 h-3 inline"></i> ${child.conditions.join(', ')}
          </div>
        ` : ''}
        
        ${child.allergies && child.allergies.length ? `
          <div class="text-xs text-red-600 mb-1">
            <i data-lucide="alert-triangle" class="w-3 h-3 inline"></i> Allergies: ${child.allergies.join(', ')}
          </div>
        ` : ''}
        
        ${child.regularMedications && child.regularMedications.length ? `
          <div class="text-xs text-[#7B68A6]600 mb-2">
            <i data-lucide="pill" class="w-3 h-3 inline"></i> Regular: ${child.regularMedications.join(', ')}
          </div>
        ` : ''}
        
        ${medStatusHTML}
        
        ${prescriptions.length > 0 ? `
          <div class="mt-3 pt-3 border-t">
            <div class="text-xs font-semibold text-gray-700 mb-2">Active Prescriptions:</div>
            ${prescriptions.map(p => `
              <div class="bg-[#7B68A6]50 p-2 rounded text-xs mb-1">
                <div class="flex justify-between items-start">
                  <div>
                    <div class="font-semibold">${escapeHtml(p.medication)}</div>
                    <div class="text-gray-600">${p.dose}${p.unit||'ml'} ${p.frequency}</div>
                    ${p.nextDose ? `<div class="text-xs text-[#7B68A6]700">Next: ${formatDateTime(p.nextDose)}</div>` : ''}
                  </div>
                  <div class="flex gap-1">
                    <button class="btn-record-dose bg-green-500 text-white px-2 py-1 rounded text-xs" data-prescription-id="${p.id}">Record</button>
                    <button class="btn-delete-presc text-red-500" data-id="${p.id}">
                      <i data-lucide="x" class="w-3 h-3"></i>
                    </button>
                  </div>
                </div>
              </div>
            `).join('')}
          </div>
        ` : ''}
        
        <div class="mt-3 flex flex-wrap gap-2">
          <button class="btn-add-record bg-green-600 text-white px-3 py-1 rounded text-sm flex items-center gap-1" data-id="${child.id}">
            <i data-lucide="plus" class="w-3 h-3"></i> Add Record
          </button>
          <button class="btn-view-records bg-[#004680] text-white px-3 py-1 rounded text-sm" data-id="${child.id}">
            View Records (${records.length})
          </button>
          <button class="btn-add-prescription bg-[#7B68A6]600 text-white px-3 py-1 rounded text-sm flex items-center gap-1" data-id="${child.id}">
            <i data-lucide="file-plus" class="w-3 h-3"></i> Prescription
          </button>
          <button class="btn-edit-child bg-gray-500 text-white px-3 py-1 rounded text-sm" data-id="${child.id}">Edit</button>
          <button class="btn-export bg-blue-500 text-white px-3 py-1 rounded text-sm flex items-center gap-1" data-id="${child.id}">
            <i data-lucide="download" class="w-3 h-3"></i> Export
          </button>
        </div>
      </div>
    `;
  }).join('');
  
  attachChildrenEvents();
}

function attachChildrenEvents() {
  document.querySelectorAll('.btn-edit-child').forEach(b => b.onclick = e => {
    const child = state.children.find(c => c.id === e.currentTarget.dataset.id);
    if (child) openChildModal('edit', child);
  });
  document.querySelectorAll('.btn-delete-child').forEach(b => b.onclick = e => {
    deleteChild(e.currentTarget.dataset.id);
  });
  document.querySelectorAll('.btn-add-record').forEach(b => b.onclick = e => {
    openRecordModal(e.currentTarget.dataset.id);
  });
  document.querySelectorAll('.btn-view-records').forEach(b => b.onclick = e => {
    openRecordsViewer(e.currentTarget.dataset.id);
  });
  document.querySelectorAll('.btn-add-prescription').forEach(b => b.onclick = e => {
    openPrescriptionModal(e.currentTarget.dataset.id);
  });
  document.querySelectorAll('.btn-export').forEach(b => b.onclick = e => {
    exportData(e.currentTarget.dataset.id);
  });
  document.querySelectorAll('.btn-delete-presc').forEach(b => b.onclick = e => {
    deletePrescription(e.currentTarget.dataset.id);
  });
  document.querySelectorAll('.btn-record-dose').forEach(b => b.onclick = e => {
    recordDoseFromPrescription(e.currentTarget.dataset.prescriptionId);
  });
}

/* ===========================
   Child CRUD
   =========================== */

function addChild(child) {
  child.id = uid();
  state.children.push(child);
  persistAndRender();
}

function updateChild(updated) {
  state.children = state.children.map(c => c.id === updated.id ? updated : c);
  persistAndRender();
}

function deleteChild(id) {
  if (!confirm('Delete child and all associated data?')) return;
  state.children = state.children.filter(c => c.id !== id);
  state.records = state.records.filter(r => r.childId !== id);
  state.prescriptions = state.prescriptions.filter(p => p.childId !== id);
  persistAndRender();
}

/* ===========================
   Records
   =========================== */

function addRecord(rec) {
  rec.id = uid();
  if (!rec.timestamp) {
    rec.timestamp = new Date().toISOString();
  }
  state.records.unshift(rec);
  
  // Update prescription next dose if medication was from prescription
  if (rec.prescriptionId) {
    state.prescriptions = state.prescriptions.map(p => {
      if (p.id === rec.prescriptionId) {
        p.nextDose = calculateNextDoseISO(p.frequency);
      }
      return p;
    });
  }
  
  persistAndRender();
}

function deleteRecord(id) {
  if (!confirm('Delete this record?')) return;
  state.records = state.records.filter(r => r.id !== id);
  persistAndRender();
}

function getRecordsForChild(childId) {
  return state.records.filter(r => r.childId === childId).sort((a,b) => new Date(b.timestamp)-new Date(a.timestamp));
}

/* ===========================
   Prescriptions
   =========================== */

function addPrescription(presc) {
  presc.id = uid();
  presc.startDate = new Date().toISOString();
  presc.nextDose = calculateNextDoseISO(presc.frequency);
  state.prescriptions.push(presc);
  persistAndRender();
}

function deletePrescription(id) {
  if (!confirm('Delete prescription?')) return;
  state.prescriptions = state.prescriptions.filter(p => p.id !== id);
  persistAndRender();
}

function getPrescriptionsForChild(childId) {
  return state.prescriptions.filter(p => p.childId === childId);
}

function recordDoseFromPrescription(prescId) {
  const p = state.prescriptions.find(x => x.id === prescId);
  if (!p) return alert('Prescription not found');
  
  const rec = {
    childId: p.childId,
    temperature: '',
    symptoms: [],
    medication: p.medication,
    medicationGeneric: p.medicationGeneric,
    dose: p.dose,
    unit: p.unit || 'ml',
    prescriptionId: p.id,
    notes: 'Dose recorded from prescription',
    timestamp: new Date().toISOString()
  };
  
  addRecord(rec);
  alert('Dose recorded and next dose scheduled.');
}

/* ===========================
   Export
   =========================== */

function exportData(childId) {
  const child = state.children.find(c => c.id === childId);
  if (!child) return;
  
  const childRecords = getRecordsForChild(childId);
  const childPresc = getPrescriptionsForChild(childId);
  const activeMeds = getActiveMedications(childId);

  let text = `*DOSED - MEDICAL SUMMARY*\n\n`;
  text += `*Child:* ${child.name}\n`;
  text += `*Age:* ${child.age || 'Not set'}\n`;
  if (child.weight) text += `*Weight:* ${child.weight} kg\n`;
  
  if (child.conditions && child.conditions.length) {
    text += `*Conditions:* ${child.conditions.join(', ')}\n`;
  }
  if (child.allergies && child.allergies.length) {
    text += `*‚ö†Ô∏è Allergies:* ${child.allergies.join(', ')}\n`;
  }
  
  if (activeMeds.length > 0) {
    text += `\n*üíä ACTIVE MEDICATIONS (Last 24h):*\n`;
    activeMeds.forEach(med => {
      const nextDose = new Date(new Date(med.timestamp).getTime() + (med.interval * 60 * 60 * 1000));
      text += `‚Ä¢ ${med.name}\n`;
      text += `  Last: ${formatDateTime(med.timestamp)}\n`;
      text += `  Next: ${formatDateTime(nextDose.toISOString())}\n`;
    });
  }
  
  if (childPresc.length > 0) {
    text += `\n*üìã CURRENT PRESCRIPTIONS:*\n`;
    childPresc.forEach(p => {
      text += `‚Ä¢ ${p.medication} (${p.medicationGeneric || ''})\n`;
      text += `  Dose: ${p.dose}${p.unit||'ml'} ${p.frequency}\n`;
      if (p.nextDose) text += `  Next: ${formatDateTime(p.nextDose)}\n`;
    });
  }
  
  text += `\n*RECENT RECORDS:*\n\n`;
  childRecords.slice(0, 15).forEach(r => {
    text += `üìÖ ${formatDateTime(r.timestamp)}\n`;
    if (r.temperature) text += `üå°Ô∏è ${r.temperature}¬∞C\n`;
    if (r.symptoms && r.symptoms.length) text += `Symptoms: ${r.symptoms.join(', ')}\n`;
    if (r.medication) text += `üíä ${r.medication}: ${r.dose}${r.unit||'ml'}\n`;
    if (r.heartRate) text += `‚ù§Ô∏è ${r.heartRate} bpm\n`;
    if (r.respRate) text += `ü´Å ${r.respRate}/min\n`;
    if (r.notes) text += `üìù ${r.notes}\n`;
    text += `\n`;
  });

  // WhatsApp share
  const url = `https://wa.me/?text=${encodeURIComponent(text)}`;
  window.open(url, '_blank');
}

/* ===========================
   Modals
   =========================== */

function openModal(html, onClose) {
  const backdrop = document.getElementById('modalBackdrop');
  const modal = document.getElementById('modal');
  modal.innerHTML = html;
  backdrop.classList.remove('hidden');
  backdrop.classList.add('flex');
  lucide.createIcons();
  modal.querySelectorAll('.btn-modal-close').forEach(b => b.onclick = () => closeModal(onClose));
}

function closeModal(onClose) {
  const backdrop = document.getElementById('modalBackdrop');
  backdrop.classList.add('hidden');
  backdrop.classList.remove('flex');
  if (typeof onClose === 'function') onClose();
}

function openChildModal(mode='add', child = null) {
  const isEdit = mode === 'edit';
  const name = isEdit ? child.name : '';
  const age = isEdit ? child.age : '';
  const weight = isEdit ? child.weight : '';
  const conditions = isEdit && child.conditions ? child.conditions.join(', ') : '';
  const allergies = isEdit && child.allergies ? child.allergies.join(', ') : '';
  const regularMedications = isEdit && child.regularMedications ? child.regularMedications.join(', ') : '';
  const birthDate = isEdit && child.birthDate ? child.birthDate : '';

  const html = `
    <div class="flex justify-between items-center mb-4">
      <h3 class="text-xl font-semibold">${isEdit ? 'Edit' : 'Add'} Child</h3>
      <button class="btn-modal-close text-gray-500 hover:text-gray-700">
        <i data-lucide="x"></i>
      </button>
    </div>
    <div class="space-y-3">
      <label class="block">
        <span class="text-sm font-medium">Name *</span>
        <input id="ch_name" class="mt-1 block w-full border rounded px-3 py-2" value="${escapeAttr(name)}">
      </label>
      <div class="grid grid-cols-2 gap-3">
        <label class="block">
          <span class="text-sm font-medium">Age</span>
          <input id="ch_age" type="number" min="0" class="mt-1 block w-full border rounded px-3 py-2" value="${escapeAttr(age)}">
        </label>
        <label class="block">
          <span class="text-sm font-medium">Weight (kg)</span>
          <input id="ch_weight" type="number" min="0" step="0.1" class="mt-1 block w-full border rounded px-3 py-2" value="${escapeAttr(weight)}">
        </label>
      </div>
      <label class="block">
        <span class="text-sm font-medium">Birth Date</span>
        <input id="ch_birthDate" type="date" class="mt-1 block w-full border rounded px-3 py-2" value="${escapeAttr(birthDate)}">
      </label>
      <label class="block">
        <span class="text-sm font-medium">Medical Conditions <span class="text-gray-500">(comma separated)</span></span>
        <input id="ch_conditions" class="mt-1 block w-full border rounded px-3 py-2" value="${escapeAttr(conditions)}">
      </label>
      <label class="block">
        <span class="text-sm font-medium">Allergies <span class="text-gray-500">(comma separated)</span></span>
        <input id="ch_allergies" class="mt-1 block w-full border rounded px-3 py-2" value="${escapeAttr(allergies)}">
      </label>
      <label class="block">
        <span class="text-sm font-medium">Regular Medications <span class="text-gray-500">(comma separated)</span></span>
        <input id="ch_regularMedications" class="mt-1 block w-full border rounded px-3 py-2" value="${escapeAttr(regularMedications)}">
      </label>
      <div class="flex gap-2 pt-4">
        <button id="btnSaveChild" class="flex-1 bg-[#004680] text-white px-4 py-2 rounded hover:bg-[#003a6b]">
          ${isEdit ? 'Update' : 'Add'} Child
        </button>
        <button class="btn-modal-close flex-1 bg-gray-300 text-gray-700 px-4 py-2 rounded hover:bg-gray-400">
          Cancel
        </button>
      </div>
    </div>
  `;
  
  openModal(html, () => {});
  
  document.getElementById('btnSaveChild').onclick = () => {
    const childData = {
      name: document.getElementById('ch_name').value.trim(),
      age: document.getElementById('ch_age').value.trim(),
      weight: document.getElementById('ch_weight').value.trim(),
      birthDate: document.getElementById('ch_birthDate').value.trim(),
      conditions: document.getElementById('ch_conditions').value.split(',').map(s => s.trim()).filter(Boolean),
      allergies: document.getElementById('ch_allergies').value.split(',').map(s => s.trim()).filter(Boolean),
      regularMedications: document.getElementById('ch_regularMedications').value.split(',').map(s => s.trim()).filter(Boolean)
    };
    
    if (!childData.name) return alert('Please enter a name');
    
    if (isEdit) {
      childData.id = child.id;
      updateChild(childData);
    } else {
      addChild(childData);
    }
    
    closeModal();
  };
}

function openRecordModal(childId) {
  const child = state.children.find(c => c.id === childId);
  if (!child) return;
  
  const prescriptions = getPrescriptionsForChild(childId);
  
  const html = `
    <div class="flex justify-between items-center mb-4">
      <h3 class="text-xl font-semibold">Add Record for ${escapeHtml(child.name)}</h3>
      <button class="btn-modal-close text-gray-500 hover:text-gray-700">
        <i data-lucide="x"></i>
      </button>
    </div>
    
    <!-- Time Selection -->
    <div class="mb-4">
      <label class="text-sm font-medium mb-2 block">When was this recorded?</label>
      <div class="flex gap-2">
        <button id="timeNow" class="time-btn active flex-1 px-4 py-2 rounded border-2 border-gray-300">Now</button>
        <button id="timeCustom" class="time-btn flex-1 px-4 py-2 rounded border-2 border-gray-300">Custom Time</button>
      </div>
      <input type="datetime-local" id="customTimestamp" class="hidden mt-2 w-full border rounded px-3 py-2">
    </div>
    
    <div class="space-y-3">
      <label class="block">
        <span class="text-sm font-medium">Temperature (¬∞C)</span>
        <input id="rec_temp" type="number" step="0.1" class="mt-1 block w-full border rounded px-3 py-2" placeholder="37.5">
      </label>
      
      <div>
        <span class="text-sm font-medium block mb-2">Symptoms (click to select)</span>
        <div id="symptomTags" class="flex flex-wrap gap-2">
          ${COMMON_SYMPTOMS.map(s => `<span class="symptom-tag px-3 py-1 rounded-full cursor-pointer bg-gray-200 hover:bg-indigo-200" data-symptom="${s}">${s}</span>`).join('')}
        </div>
      </div>
      
      ${prescriptions.length > 0 ? `
        <div class="bg-[#7B68A6]50 p-3 rounded">
          <label class="block">
            <span class="text-sm font-medium">Quick-fill from Prescription</span>
            <select id="quickFillPresc" class="mt-1 block w-full border rounded px-3 py-2">
              <option value="">-- Select prescription --</option>
              ${prescriptions.map(p => `<option value="${p.id}">${p.medication} - ${p.dose}${p.unit||'ml'}</option>`).join('')}
            </select>
          </label>
        </div>
      ` : ''}
      
      <label class="block">
        <div class="flex justify-between items-center mb-1">
          <span class="text-sm font-medium">Medication</span>
          <button id="btnScanBarcode" type="button" class="text-xs bg-[#7B68A6]100 text-[#7B68A6]700 px-2 py-1 rounded flex items-center gap-1 hover:bg-[#7B68A6]200">
            <i data-lucide="scan-barcode" class="w-3 h-3"></i> Scan Barcode
          </button>
        </div>
        <select id="rec_med" class="mt-1 block w-full border rounded px-3 py-2">
          <option value="">-- Select medication --</option>
          ${MEDICINES.map(m => `<option value="${m.name}">${m.name} (${m.generic})</option>`).join('')}
        </select>
      </label>
      
      <!-- Barcode Scanner Modal (hidden by default) -->
      <div id="barcodeScannerModal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-4 max-w-md w-full mx-4">
          <div class="flex justify-between items-center mb-3">
            <h4 class="font-semibold">Scan Medicine Barcode</h4>
            <button id="closeBarcodeScanner" class="text-gray-500 hover:text-gray-700">
              <i data-lucide="x"></i>
            </button>
          </div>
          <div class="relative bg-black rounded overflow-hidden" style="aspect-ratio: 4/3;">
            <video id="barcodeVideo" class="w-full h-full object-cover"></video>
            <div id="scanningOverlay" class="absolute inset-0 flex items-center justify-center">
              <div class="w-64 h-48 border-2 border-green-400 rounded-lg"></div>
            </div>
          </div>
          <div id="barcodeResult" class="mt-3 hidden">
            <div class="bg-green-50 border border-green-200 rounded p-3">
              <div class="text-sm font-medium text-green-800">Barcode Detected:</div>
              <div id="barcodeValue" class="text-lg font-bold text-green-900 mt-1"></div>
              <div id="medicineMatch" class="text-sm text-green-700 mt-2"></div>
            </div>
          </div>
          <div class="mt-3 text-xs text-gray-600">
            <p>Position the barcode within the frame. Common locations on medicine bottles:</p>
            <ul class="list-disc list-inside mt-1">
              <li>Bottom of bottle</li>
              <li>Back label</li>
              <li>Side of box</li>
            </ul>
          </div>
        </div>
      </div>
      
      <div id="doseRecommendation" class="hidden bg-blue-50 p-3 rounded">
        <div class="text-sm font-medium mb-1">Recommended Dose:</div>
        <div id="doseText" class="text-blue-900 font-semibold"></div>
      </div>
      
      <div class="grid grid-cols-3 gap-2">
        <label class="col-span-2 block">
          <span class="text-sm font-medium">Dose</span>
          <input id="rec_dose" type="number" step="0.1" class="mt-1 block w-full border rounded px-3 py-2">
        </label>
        <label class="block">
          <span class="text-sm font-medium">Unit</span>
          <select id="rec_unit" class="mt-1 block w-full border rounded px-3 py-2">
            <option value="ml">ml</option>
            <option value="mg">mg</option>
            <option value="puffs">puffs</option>
            <option value="tablets">tablets</option>
          </select>
        </label>
      </div>
      
      <div class="grid grid-cols-2 gap-3">
        <label class="block">
          <span class="text-sm font-medium">Heart Rate (bpm)</span>
          <input id="rec_hr" type="number" min="0" max="300" class="mt-1 block w-full border rounded px-3 py-2" placeholder="e.g., 120">
        </label>
        <label class="block">
          <span class="text-sm font-medium">Respiratory Rate (/min)</span>
          <input id="rec_rr" type="number" min="0" max="100" class="mt-1 block w-full border rounded px-3 py-2" placeholder="e.g., 25">
        </label>
      </div>
      
      <label class="block">
        <span class="text-sm font-medium">Notes</span>
        <textarea id="rec_notes" rows="2" class="mt-1 block w-full border rounded px-3 py-2"></textarea>
      </label>
      
      <div class="flex gap-2 pt-4">
        <button id="btnSaveRecord" class="flex-1 bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">
          Save Record
        </button>
        <button class="btn-modal-close flex-1 bg-gray-300 text-gray-700 px-4 py-2 rounded hover:bg-gray-400">
          Cancel
        </button>
      </div>
    </div>
  `;
  
  openModal(html, () => {});
  
  // Initialize barcode scanner
  initBarcodeScanner();
  
  // Time selection
  let timeMode = 'now';
  document.getElementById('timeNow').onclick = () => {
    timeMode = 'now';
    document.getElementById('timeNow').classList.add('active');
    document.getElementById('timeCustom').classList.remove('active');
    document.getElementById('customTimestamp').classList.add('hidden');
  };
  document.getElementById('timeCustom').onclick = () => {
    timeMode = 'custom';
    document.getElementById('timeCustom').classList.add('active');
    document.getElementById('timeNow').classList.remove('active');
    const input = document.getElementById('customTimestamp');
    input.classList.remove('hidden');
    const now = new Date();
    now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
    input.value = now.toISOString().slice(0, 16);
  };
  
  // Symptom selection
  const selectedSymptoms = [];
  document.querySelectorAll('.symptom-tag').forEach(tag => {
    tag.onclick = () => {
      const symptom = tag.dataset.symptom;
      if (selectedSymptoms.includes(symptom)) {
        selectedSymptoms.splice(selectedSymptoms.indexOf(symptom), 1);
        tag.classList.remove('bg-[#004680]', 'text-white');
        tag.classList.add('bg-gray-200');
      } else {
        selectedSymptoms.push(symptom);
        tag.classList.add('bg-[#004680]', 'text-white');
        tag.classList.remove('bg-gray-200');
      }
    };
  });
  
  // Quick-fill from prescription
  if (prescriptions.length > 0) {
    document.getElementById('quickFillPresc').onchange = (e) => {
      const prescId = e.target.value;
      if (!prescId) return;
      const presc = prescriptions.find(p => p.id === prescId);
      if (presc) {
        document.getElementById('rec_med').value = presc.medication;
        document.getElementById('rec_dose').value = presc.dose;
        document.getElementById('rec_unit').value = presc.unit || 'ml';
        document.getElementById('rec_med').dispatchEvent(new Event('change'));
      }
    };
  }
  
  // Dose recommendation
  document.getElementById('rec_med').onchange = (e) => {
    const medName = e.target.value;
    if (!medName || !child.weight) {
      document.getElementById('doseRecommendation').classList.add('hidden');
      return;
    }
    
    const rec = getRecommendedDose(medName, child.weight);
    if (rec) {
      document.getElementById('doseText').innerHTML = `
        <div>${rec.dose} ${rec.unit} (${rec.ageGuide})</div>
        <div class="text-sm mt-1">Give every ${rec.interval} hours</div>
        ${rec.notes ? `<div class="text-xs mt-1 text-gray-600">${rec.notes}</div>` : ''}
        <button id="useDose" class="mt-2 bg-[#004680] text-white px-3 py-1 rounded text-sm">Use This Dose</button>
      `;
      document.getElementById('doseRecommendation').classList.remove('hidden');
      
      document.getElementById('useDose').onclick = () => {
        document.getElementById('rec_dose').value = rec.dose;
        document.getElementById('rec_unit').value = rec.unit;
      };
    } else {
      document.getElementById('doseRecommendation').classList.add('hidden');
    }
  };
  
  // Save record
  document.getElementById('btnSaveRecord').onclick = () => {
    const timestamp = timeMode === 'custom' ? 
      new Date(document.getElementById('customTimestamp').value).toISOString() :
      new Date().toISOString();
    
    const medication = document.getElementById('rec_med').value;
    const medObj = medication ? MEDICINES.find(m => m.name === medication) : null;
    
    const rec = {
      childId: childId,
      timestamp: timestamp,
      temperature: document.getElementById('rec_temp').value,
      symptoms: selectedSymptoms,
      medication: medication,
      medicationGeneric: medObj ? medObj.generic : '',
      dose: document.getElementById('rec_dose').value,
      unit: document.getElementById('rec_unit').value,
      heartRate: document.getElementById('rec_hr').value,
      respRate: document.getElementById('rec_rr').value,
      notes: document.getElementById('rec_notes').value
    };
    
    addRecord(rec);
    closeModal();
  };
}

function openPrescriptionModal(childId) {
  const child = state.children.find(c => c.id === childId);
  if (!child) return;
  
  const html = `
    <div class="flex justify-between items-center mb-4">
      <h3 class="text-xl font-semibold">Add Prescription for ${escapeHtml(child.name)}</h3>
      <button class="btn-modal-close text-gray-500 hover:text-gray-700">
        <i data-lucide="x"></i>
      </button>
    </div>
    <div class="space-y-3">
      <label class="block">
        <div class="flex justify-between items-center mb-1">
          <span class="text-sm font-medium">Medication</span>
          <button id="btnScanBarcodePresc" type="button" class="text-xs bg-[#7B68A6]100 text-[#7B68A6]700 px-2 py-1 rounded flex items-center gap-1 hover:bg-[#7B68A6]200">
            <i data-lucide="scan-barcode" class="w-3 h-3"></i> Scan Barcode
          </button>
        </div>
        <select id="presc_med" class="mt-1 block w-full border rounded px-3 py-2">
          <option value="">-- Select medication --</option>
          ${MEDICINES.map(m => `<option value="${m.name}">${m.name} (${m.generic})</option>`).join('')}
        </select>
      </label>
      
      <!-- Barcode Scanner Modal for Prescription -->
      <div id="barcodeScannerModalPresc" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-4 max-w-md w-full mx-4">
          <div class="flex justify-between items-center mb-3">
            <h4 class="font-semibold">Scan Medicine Barcode</h4>
            <button id="closeBarcodeScannerPresc" class="text-gray-500 hover:text-gray-700">
              <i data-lucide="x"></i>
            </button>
          </div>
          <div class="relative bg-black rounded overflow-hidden" style="aspect-ratio: 4/3;">
            <video id="barcodeVideoPresc" class="w-full h-full object-cover"></video>
            <div class="absolute inset-0 flex items-center justify-center">
              <div class="w-64 h-48 border-2 border-green-400 rounded-lg"></div>
            </div>
          </div>
          <div id="barcodeResultPresc" class="mt-3 hidden">
            <div class="bg-green-50 border border-green-200 rounded p-3">
              <div class="text-sm font-medium text-green-800">Barcode Detected:</div>
              <div id="barcodeValuePresc" class="text-lg font-bold text-green-900 mt-1"></div>
              <div id="medicineMatchPresc" class="text-sm text-green-700 mt-2"></div>
            </div>
          </div>
        </div>
      </div>
      
      <div id="prescDoseRec" class="hidden bg-blue-50 p-3 rounded">
        <div class="text-sm font-medium mb-1">Recommended Dose:</div>
        <div id="prescDoseText" class="text-blue-900 font-semibold"></div>
      </div>
      
      <div class="grid grid-cols-3 gap-2">
        <label class="col-span-2 block">
          <span class="text-sm font-medium">Dose</span>
          <input id="presc_dose" type="number" step="0.1" class="mt-1 block w-full border rounded px-3 py-2">
        </label>
        <label class="block">
          <span class="text-sm font-medium">Unit</span>
          <select id="presc_unit" class="mt-1 block w-full border rounded px-3 py-2">
            <option value="ml">ml</option>
            <option value="mg">mg</option>
            <option value="puffs">puffs</option>
            <option value="tablets">tablets</option>
          </select>
        </label>
      </div>
      
      <label class="block">
        <span class="text-sm font-medium">Frequency</span>
        <select id="presc_freq" class="mt-1 block w-full border rounded px-3 py-2">
          <option value="OD">OD (Once daily)</option>
          <option value="BD">BD (Twice daily)</option>
          <option value="TDS">TDS (Three times daily)</option>
          <option value="QDS">QDS (Four times daily)</option>
        </select>
      </label>
      
      <label class="block">
        <span class="text-sm font-medium">Duration (days)</span>
        <input id="presc_duration" type="number" class="mt-1 block w-full border rounded px-3 py-2" placeholder="7">
      </label>
      
      <div class="flex gap-2 pt-4">
        <button id="btnSavePresc" class="flex-1 bg-[#7B68A6]600 text-white px-4 py-2 rounded hover:bg-[#7B68A6]700">
          Add Prescription
        </button>
        <button class="btn-modal-close flex-1 bg-gray-300 text-gray-700 px-4 py-2 rounded hover:bg-gray-400">
          Cancel
        </button>
      </div>
    </div>
  `;
  
  openModal(html, () => {});
  
  // Initialize barcode scanner for prescription
  initBarcodeScannerForElement('btnScanBarcodePresc', 'barcodeScannerModalPresc', 'closeBarcodeScannerPresc', 'barcodeVideoPresc', 'barcodeResultPresc', 'barcodeValuePresc', 'medicineMatchPresc', 'presc_med');
  
  // Dose recommendation
  document.getElementById('presc_med').onchange = (e) => {
    const medName = e.target.value;
    if (!medName || !child.weight) {
      document.getElementById('prescDoseRec').classList.add('hidden');
      return;
    }
    
    const rec = getRecommendedDose(medName, child.weight);
    if (rec) {
      document.getElementById('prescDoseText').innerHTML = `
        <div>${rec.dose} ${rec.unit} (${rec.ageGuide})</div>
        <button id="usePrescDose" class="mt-2 bg-[#004680] text-white px-3 py-1 rounded text-sm">Use This Dose</button>
      `;
      document.getElementById('prescDoseRec').classList.remove('hidden');
      
      document.getElementById('usePrescDose').onclick = () => {
        document.getElementById('presc_dose').value = rec.dose;
        document.getElementById('presc_unit').value = rec.unit;
      };
    } else {
      document.getElementById('prescDoseRec').classList.add('hidden');
    }
  };
  
  document.getElementById('btnSavePresc').onclick = () => {
    const medication = document.getElementById('presc_med').value;
    const medObj = MEDICINES.find(m => m.name === medication);
    
    const presc = {
      childId: childId,
      medication: medication,
      medicationGeneric: medObj ? medObj.generic : '',
      dose: document.getElementById('presc_dose').value,
      unit: document.getElementById('presc_unit').value,
      frequency: document.getElementById('presc_freq').value,
      duration: document.getElementById('presc_duration').value
    };
    
    if (!presc.medication || !presc.dose) return alert('Please fill in required fields');
    
    addPrescription(presc);
    closeModal();
  };
}

function openRecordsViewer(childId) {
  const child = state.children.find(c => c.id === childId);
  if (!child) return;
  
  const records = getRecordsForChild(childId);
  
  const html = `
    <div class="flex justify-between items-center mb-4">
      <h3 class="text-xl font-semibold">Records for ${escapeHtml(child.name)}</h3>
      <button class="btn-modal-close text-gray-500 hover:text-gray-700">
        <i data-lucide="x"></i>
      </button>
    </div>
    
    <div class="space-y-3 max-h-[60vh] overflow-y-auto">
      ${records.length === 0 ? '<p class="text-gray-500 text-center py-8">No records yet</p>' : 
        records.map(r => `
          <div class="border rounded p-3 ${r.medication ? 'border-l-4 border-l-green-500' : 'border-l-4 border-l-blue-500'}">
            <div class="flex justify-between items-start mb-2">
              <div class="text-sm text-gray-600">${formatDateTime(r.timestamp)}</div>
              <button class="btn-delete-record text-red-500 hover:text-red-700" data-id="${r.id}">
                <i data-lucide="trash-2" class="w-4 h-4"></i>
              </button>
            </div>
            ${r.temperature ? `<div class="text-lg font-semibold">üå°Ô∏è ${r.temperature}¬∞C</div>` : ''}
            ${r.symptoms && r.symptoms.length ? `<div class="text-sm text-gray-700 mt-1">Symptoms: ${r.symptoms.join(', ')}</div>` : ''}
            ${r.medication ? `<div class="text-sm text-green-700 mt-1">üíä ${r.medication} - ${r.dose}${r.unit}</div>` : ''}
            ${r.heartRate ? `<div class="text-sm text-gray-700 mt-1">‚ù§Ô∏è ${r.heartRate} bpm</div>` : ''}
            ${r.respRate ? `<div class="text-sm text-gray-700 mt-1">ü´Å ${r.respRate}/min</div>` : ''}
            ${r.notes ? `<div class="text-sm text-gray-600 mt-2 italic">${escapeHtml(r.notes)}</div>` : ''}
          </div>
        `).join('')
      }
    </div>
    
    <div class="mt-4 pt-4 border-t">
      <button class="btn-modal-close w-full bg-gray-300 text-gray-700 px-4 py-2 rounded hover:bg-gray-400">
        Close
      </button>
    </div>
  `;
  
  openModal(html, () => {});
  
  document.querySelectorAll('.btn-delete-record').forEach(b => {
    b.onclick = () => {
      deleteRecord(b.dataset.id);
      closeModal();
      openRecordsViewer(childId); // Reopen to refresh
    };
  });
}

/* ===========================
   Charts
   =========================== */

let tempChart, hrChart, rrChart;

document.getElementById('btnToggleTrends').onclick = () => {
  const area = document.getElementById('chartArea');
  if (area.classList.contains('hidden')) {
    area.classList.remove('hidden');
    renderCharts();
  } else {
    area.classList.add('hidden');
  }
};

function renderCharts() {
  const allRecords = state.records
    .filter(r => r.temperature)
    .sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
  
  if (allRecords.length === 0) return;
  
  const labels = allRecords.map(r => formatDateTime(r.timestamp));
  const temps = allRecords.map(r => parseFloat(r.temperature));
  const hrs = allRecords.map(r => r.heartRate ? parseInt(r.heartRate) : null);
  const rrs = allRecords.map(r => r.respRate ? parseInt(r.respRate) : null);
  
  if (tempChart) tempChart.destroy();
  if (hrChart) hrChart.destroy();
  if (rrChart) rrChart.destroy();
  
  setTimeout(() => {
    tempChart = new Chart(document.getElementById('tempChart'), {
      type: 'line',
      data: {
        labels: labels,
        datasets: [{
          label: 'Temperature (¬∞C)',
          data: temps,
          borderColor: '#EF4444',
          backgroundColor: 'rgba(239, 68, 68, 0.1)',
          tension: 0.3
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: { y: { min: 35, max: 42 } }
      }
    });
    
    if (hrs.some(h => h !== null)) {
      hrChart = new Chart(document.getElementById('hrChart'), {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'Heart Rate (bpm)',
            data: hrs,
            borderColor: '#EC4899',
            backgroundColor: 'rgba(236, 72, 153, 0.1)',
            tension: 0.3
          }]
        },
        options: { responsive: true, maintainAspectRatio: false }
      });
    }
    
    if (rrs.some(r => r !== null)) {
      rrChart = new Chart(document.getElementById('rrChart'), {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'Respiratory Rate (/min)',
            data: rrs,
            borderColor: '#10B981',
            backgroundColor: 'rgba(16, 185, 129, 0.1)',
            tension: 0.3
          }]
        },
        options: { responsive: true, maintainAspectRatio: false }
      });
    }
  }, 100);
}

/* ===========================
   Barcode Scanner
   =========================== */

let barcodeStream = null;
let barcodeDetectionInterval = null;

function initBarcodeScanner() {
  const scanBtn = document.getElementById('btnScanBarcode');
  const scanModal = document.getElementById('barcodeScannerModal');
  const closeBtn = document.getElementById('closeBarcodeScanner');
  const video = document.getElementById('barcodeVideo');
  
  if (!scanBtn) return;
  
  scanBtn.onclick = async () => {
    scanModal.classList.remove('hidden');
    document.getElementById('barcodeResult').classList.add('hidden');
    
    try {
      barcodeStream = await navigator.mediaDevices.getUserMedia({ 
        video: { facingMode: 'environment' } // Use back camera on mobile
      });
      video.srcObject = barcodeStream;
      video.play();
      
      // Start scanning
      startBarcodeDetection(video);
    } catch (err) {
      alert('Camera access denied or not available. Please allow camera access to scan barcodes.');
      scanModal.classList.add('hidden');
    }
  };
  
  closeBtn.onclick = () => {
    stopBarcodeScanning();
    scanModal.classList.add('hidden');
  };
  
  // Close on clicking outside
  scanModal.onclick = (e) => {
    if (e.target === scanModal) {
      stopBarcodeScanning();
      scanModal.classList.add('hidden');
    }
  };
}

function stopBarcodeScanning() {
  if (barcodeStream) {
    barcodeStream.getTracks().forEach(track => track.stop());
    barcodeStream = null;
  }
  if (barcodeDetectionInterval) {
    clearInterval(barcodeDetectionInterval);
    barcodeDetectionInterval = null;
  }
}

function startBarcodeDetection(video) {
  // Try using BarcodeDetector API if available (Chrome/Edge on Android)
  if ('BarcodeDetector' in window) {
    const barcodeDetector = new BarcodeDetector({ formats: ['ean_13', 'ean_8', 'upc_a', 'upc_e'] });
    
    barcodeDetectionInterval = setInterval(async () => {
      try {
        const barcodes = await barcodeDetector.detect(video);
        if (barcodes.length > 0) {
          handleBarcodeDetected(barcodes[0].rawValue);
        }
      } catch (err) {
        // Continue scanning
      }
    }, 500);
  } else {
    // Fallback: Use ZXing library via CDN
    loadZXingAndScan(video);
  }
}

function loadZXingAndScan(video) {
  // Load ZXing library dynamically
  if (!window.ZXing) {
    const script = document.createElement('script');
    script.src = 'https://unpkg.com/@zxing/library@latest/umd/index.min.js';
    script.onload = () => startZXingScanning(video);
    document.head.appendChild(script);
  } else {
    startZXingScanning(video);
  }
}

function startZXingScanning(video) {
  const codeReader = new ZXing.BrowserMultiFormatReader();
  
  codeReader.decodeFromVideoDevice(null, video, (result, err) => {
    if (result) {
      handleBarcodeDetected(result.text);
      codeReader.reset();
    }
  });
  
  // Store for cleanup
  barcodeDetectionInterval = { reader: codeReader };
}

function handleBarcodeDetected(barcode) {
  console.log('Barcode detected:', barcode);
  
  // Show result
  document.getElementById('barcodeValue').textContent = barcode;
  document.getElementById('barcodeResult').classList.remove('hidden');
  
  // Check if we have this medicine in our database
  const medicineName = MEDICINE_BARCODES[barcode];
  const matchDiv = document.getElementById('medicineMatch');
  
  if (medicineName) {
    matchDiv.innerHTML = `‚úì Matched: <strong>${medicineName}</strong>`;
    
    // Auto-select in dropdown
    const select = document.getElementById('rec_med');
    if (select) {
      select.value = medicineName;
      select.dispatchEvent(new Event('change'));
    }
    
    // Close scanner after 1.5 seconds
    setTimeout(() => {
      stopBarcodeScanning();
      document.getElementById('barcodeScannerModal').classList.add('hidden');
    }, 1500);
  } else {
    matchDiv.innerHTML = `Medicine not found in database. You can still select manually.<br><small class="text-xs">Barcode: ${barcode}</small>`;
    
    // Store barcode for potential future matching
    const customBarcode = {
      barcode: barcode,
      timestamp: new Date().toISOString()
    };
    const customBarcodes = JSON.parse(localStorage.getItem('dosed_custom_barcodes') || '[]');
    customBarcodes.push(customBarcode);
    localStorage.setItem('dosed_custom_barcodes', JSON.stringify(customBarcodes));
    
    // Don't auto-close so user can manually select
  }
  
  // Play success sound (optional)
  try {
    const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSl+zPDTjDoKGmS46+SfTgwOUKXh8LljGwU7k9nyz3wsBSp7y+/ajz0KFmG25Od9LgYcd8vw1Ic3BxdjuOrrm0wMDk+m4fG7ZB0FO5LY8tB8LQUrfMvv24I6CRZhtuTnfi8GHHjM8NWHNgcXY7jq6ptNDA5PpuDxvGQeBTuR2PLPfC0FK3zL79uCOwkWYbbk6H4vBhx4zPDVhzYHF2O46uqbTQwOT6bg8bxkHgU8kdfy0HwtBSt8y+/cgjsJFmG25Oh+LwYceMzw1Yc2Bxdjt+rqm00MDk+n4PG8ZB4FPJHYPGQeBTuR1/LQfC0FK3zL79uBOgkWYbbk6H4vBhx4zPDVhzYHF2O36uqbTQwOT6fg8bxkHgU8kdfy0HwtBSt8y+/bgToJFmG25Oh+LwYceMzw1Yc2Bxdjt+rqm00MDk+n4PG8ZB4FPJHYPGQeBTuR1/LQfC0FK3zL79uBOgkWYbbk6H4vBhx4zPDVhzYHF2O36uqbTQwOT6fg8bxkHgU8kdfy0HwtBSt8y+/bgToJFmG25Oh+LwYceMzw1Yc2Bxdjt+rqm00MDk+n4PG8ZB4FPJHYPGQeBTuR1/LQfC0FK3zL79uBOgkWYbbk6H4vBhx4zPDVhzYHF2O36uqbTQwOT6fg8bxkHgU8kdfy0HwtBSt8y+/bgToJFmG25Oh+LwYceMzw1Yc2Bxdjt+rqm00MDk+n4PG8ZB4FPJHYPGQeBTuR1/LQfC0FK3zL79uBOgkWYbbk6H4vBhx4zPDVhzYHF2O36uqbTQwOT6fg8bxkHgU8kdfy0HwtBSt8y+/bgToJFmG25Oh+LwYceMzw1Yc2Bxdjt+rqm00MDk+n4PG8ZB4FPJHYPGQeBTuR1/LQfC0FK3zL79uBOgkWYbbk6H4vBhx4zPDVhzYHF2O36uqbTQwOT6fg8bxkHgU8kdfy0HwtBSt8y+/bgToJFmG25Oh+LwYceMzw1Yc2Bxdjt+rqm00MDk+n4PG8ZB4FPJHYPGQeBTuR1/LQfC0FK3zL79uBOgkWYbbk6H4vBhx4zPDVhzYHF2O36uqbTQwOT6fg8bxkHgU8kdfy0HwtBSt8y+/bgToJFmG25Oh+LwYceMzw1Yc2Bxdjt+rqm00MDk+n4PG8ZB4FPJHYPGQeBTuR1/LQfC0FK3zL79uBOgkWYbbk6H4vBhx4zPDVhzYHF2O36uqbTQwOT6fg8bxkHgU8kdfy0HwtBSt8y+/bgToJFmG25Oh+LwYceMzw1Yc2Bxdjt+rqm00MDk+n4PG8ZB4FPJHYPGQeBTuR1/LQfC0FK3zL79uBOgkWYbbk6H4vBhx4zPDVhzYHF2O36uqbTQwOT6fg8bxkHgU8kdfy0HwtBSt8y+/bgToJFmG25Oh+LwYceMzw1Yc2Bxdjt+rqm00MDk+n4PG8ZB4FPJHYPGQeBTuR1/LQfC0FK3zL79uBOgkWYbbk6H4vBhx4zPDVhzYHF2O36uqbTQwOT6fg8bxkHgU8kdfy0HwtBSt8y+/bgToJFmG25Oh+LwYceMzw1Yc2Bxdjt+rqm00MDk+n4PG8ZB4FPJHYPGQeBTuR1/LQfC0FK3zL79uBOgkWYbbk6H4vBhx4zPDVhzYHF2O36uqbTQwOT6fg8bxkHgU8kdfy0HwtBSt8y+/bgToJFmG25Oh+LwYceMzw1Yc2Bxdjt+rqm00MDk+n4PG8ZB4FPJHYPGQeBTuR1/LQfC0FK3zL79uBOgkWYbbk6H4vBhx4zPDVhzYHF2O36uqbTQwOT6fg8bxkHgU8kdfy0HwtBSt8y+/bgToJFmG25Oh+LwYceMzw1Yc2Bxdjt+rqm00MDk+n4PG8ZB4FPJHYPGQeBTuR1/LQfC0FK3zL79uBOgkWYbbk6H4vBhx4zPDVhzYHF2O36uqbTQwOT6fg8bxkHgU8kdfy0HwtBSt8y+/bgToJFmG25Oh+LwYceMzw1Yc2Bxdjt+rqm00MDk+n4PG8ZB4FPJHYPGQeBTuR1/LQfC0FK3zL79uBOgk=');
    audio.play().catch(() => {});
  } catch (err) {
    // Ignore audio errors
  }
}

/* ===========================
   Init
   =========================== */

document.getElementById('btnAddChild').onclick = () => openChildModal('add');

render();
setInterval(checkReminders, 60000); // Check every minute

if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('sw.js').catch(() => {});
}

lucide.createIcons();
</script>

</body>
</html>
